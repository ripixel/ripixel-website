[
  {
    "section": "thoughts",
    "itemName": "2023-01-04_Enabling-dark-mode",
    "itemPath": "./items/thoughts/2023-01-04_Enabling-dark-mode.md",
    "outPath": "./public/thoughts/2023-01-04_Enabling-dark-mode.html",
    "relativePath": "thoughts/2023-01-04_Enabling-dark-mode.html",
    "type": "md",
    "date": "2023-01-04T00:00:00.000Z",
    "dateObj": "2023-01-04T00:00:00.000Z",
    "dateDisplay": "4 January 2023",
    "title": "Enabling Dark Mode",
    "excerpt": "Ever thought \"ewww this site is so bright?!\" and then searched for the \"dark mode\" button? I'm one of those people too, and despite my love of bright blocks of colour I decided that implementing a dark mode switch would be a good idea.",
    "body": "Ever thought \"ewww this site is so bright?!\" and then searched for the \"dark mode\" button? I'm one of those people too, and despite my love of bright blocks of colour I decided that implementing a dark mode switch would be a good idea.\n\nAdditionally, I hate it when things _default_ to light mode, even though my machine is set to dark mode! So in this little guide, I'll walk you through how I implemented a machine-aware dark mode for this site.\n\n## What's the plan?\n\nAs this site is very simple and static (no server-side rendering here, just good ol' fashioned HTML and CSS), I'll need to implement a client-side-only dark mode. This means I'll need to:\n\n - Figure out how I want to \"apply\" a dark mode across the site using CSS\n - Figure out the JavaScript to enable this dark mode\n\n## How to apply dark mode in HTML\n\nThis one's quite simple, and I didn't want to muck around too much. As my site is powered by basic CSS (no CSS-in-JS or anything of that ilk), I can just apply a class to the `<body>` element, and then select on that!\n\nSo if it's in light mode, the body will just be:\n\n```html\n<body>\n  <h1>Content</h1>\n</body>\n```\n\nBut in dark mode, it'll be:\n\n```html\n<body class=\"dark\">\n  <h1>Content</h1>\n</body>\n```\n\nThat means in CSS I can then do things like:\n\n```css\n// light mode is default\nbody {\n  background: white;\n}\n\nh1 {\n  color: black;\n}\n\n// dark mode has a more specific selector, so will override the light mode\nbody.dark {\n  background: black;\n}\n\n.dark h1 {\n  color: white;\n}\n```\n\n## How to define the dark CSS styles\n\nMy site has a single `styles.css` that defines the site's theme, along with a `reset.css` for resetting browser defaults to 0 values and `syntax_highlight.css` for my syntax block styling. All these live in a `styles` folder, and my build process merges them all together and minifies them.\n\nSo, my plan is to copy/paste my `styles.css` to `styles_dark.css`, and remove any properties that aren't about colours. It was a slightly tedious process, but only took me 15 minutes to isolate all the colour values in my CSS. Now during development (before I've created the JavaScript), I manually added the `dark` class to my body element, and ran the site in development mode.\n\nNow I've got a file with just the colours, I prepend the `.dark` class selector to the beginning of each of them. Because it's a standard CSS file, I select all instances of `{` using VS Code `CTRL/CMD + D`, then hit the `Home` key to take me to the beginning of each line, and smack in `.dark` - now all my `styles_dark.css` selectors are prefixed with the correct selector - neat!\n\nWith my site running in development mode and the body being hard-coded to be `class=\"dark\"`, I just modified all the values until I was happy with the darker theme.\n\nIf this sounds like a lot of manual steps, it is! But only because my site is very, _very_ simplistic in its implementation for maximum speed/ease of maintenance.\n\n## How to flip between light and dark mode\n\n### Simple functionality\n\nNow I've decided on adding the `dark` class to my `<body>` tag, I can write some JavaScript to control this functionality. To begin with, I just added a button to the top of my home page (who cares about styling right now), and some simple JavaScript:\n\n```html\n<!-- HTML -->\n\n<!-- At the top of my home page -->\n<button onclick=\"switchMode()\">Switch dark/light mode</button>\n\n<!-- Just before the closing body tag -->\n<script>\n  var darkMode = false;\n  function switchMode() {\n    if (darkMode) {\n      darkMode = false;\n      document.body.classList.remove('dark');\n    } else {\n      darkMode = true;\n      document.body.classList.add('dark');\n    }\n  }\n</script>\n```\n\nHooray! Now the site switches between light and dark mode as expected.\n\n### Remembering preference\n\nNow we're switching between modes, but it doesn't remember my last mode on page refresh! Let's use local storage to remember our value:\n\n```javascript\n// retrieve from local storage\nvar darkMode = window.localStorage.getItem('darkMode') || 'false';\nif (darkMode === 'true') {\n  document.body.classList.add('dark');\n}\n\n// enable switching functionality\nfunction switchMode() {\n  if (darkMode === 'true') {\n    darkMode = 'false';\n    document.body.classList.remove('dark');\n  } else {\n    darkMode = 'true';\n    document.body.classList.add('dark');\n  }\n  window.localStorage.setItem('darkMode', darkMode);\n}\n```\n\nNote that we have to use string versions of `true` and `false`, because local storage _always_ stores things as strings. Now our site remembers our preference, defaulting to light mode.\n\n### Honouring system preference\n\nThis is great, but if the site is being viewed on a browser/machine with dark mode enabled system-wide, we should honour that too by default:\n\n```javascript\n// detect browser setup\nif (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches && !window.localStorage.getItem('darkMode')) {\n  window.localStorage.setItem('darkMode', 'true');\n}\n\n// retrieve from local storage\nvar darkMode = window.localStorage.getItem('darkMode') || 'false';\nif (darkMode === 'true') {\n  document.body.classList.add('dark');\n}\n\n// enable switching functionality\nfunction switchMode() {\n  if (darkMode === 'true') {\n    darkMode = 'false';\n    document.body.classList.remove('dark');\n  } else {\n    darkMode = 'true';\n    document.body.classList.add('dark');\n  }\n  window.localStorage.setItem('darkMode', darkMode);\n}\n```\n\nThere are some caveats to this method (it's supported only in modern browsers), but it's good enough to cover 95% of users of the web, and I would suspect almost 100% of viewers of my site (due to the target audience). Again, it will default to light mode if it can't use `window.matchMedia`, so no harm no foul.\n\n## Pretty SVG button\n\nFinally, I updated the styling of my boring-standard button to be something snazzier, using a nice SVG of a filled or hollow sun:\n\n```html\n<section class=\"darkmode\">\n  <button onclick=\"switchMode()\">\n    <svg class=\"lightSun\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24px\" height=\"24px\" viewBox=\"0 0 48 48\">\n      <g id=\"Layer_2\" data-name=\"Layer 2\">\n        <g id=\"invisible_box\" data-name=\"invisible box\">\n          <rect width=\"48\" height=\"48\" fill=\"none\" />\n        </g>\n        <g id=\"Q3_icons\" data-name=\"Q3 icons\">\n          <g>\n            <path d=\"M24,10a2,2,0,0,0,2-2V4a2,2,0,0,0-4,0V8A2,2,0,0,0,24,10Z\" />\n            <path d=\"M24,38a2,2,0,0,0-2,2v4a2,2,0,0,0,4,0V40A2,2,0,0,0,24,38Z\" />\n            <path d=\"M36.7,14.1l2.9-2.8a2.3,2.3,0,0,0,0-2.9,2.3,2.3,0,0,0-2.9,0l-2.8,2.9a2,2,0,1,0,2.8,2.8Z\" />\n            <path d=\"M11.3,33.9,8.4,36.7a2.3,2.3,0,0,0,0,2.9,2.3,2.3,0,0,0,2.9,0l2.8-2.9a2,2,0,1,0-2.8-2.8Z\" />\n            <path d=\"M44,22H40a2,2,0,0,0,0,4h4a2,2,0,0,0,0-4Z\" />\n            <path d=\"M10,24a2,2,0,0,0-2-2H4a2,2,0,0,0,0,4H8A2,2,0,0,0,10,24Z\" />\n            <path d=\"M36.7,33.9a2,2,0,1,0-2.8,2.8l2.8,2.9a2.1,2.1,0,1,0,2.9-2.9Z\" />\n            <path d=\"M11.3,14.1a2,2,0,0,0,2.8-2.8L11.3,8.4a2.3,2.3,0,0,0-2.9,0,2.3,2.3,0,0,0,0,2.9Z\" />\n            <path d=\"M24,14A10,10,0,1,0,34,24,10,10,0,0,0,24,14Zm0,16a6,6,0,1,1,6-6A6,6,0,0,1,24,30Z\" />\n          </g>\n        </g>\n      </g>\n    </svg>\n    <svg class=\"darkSun\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24px\" height=\"24px\" viewBox=\"0 0 48 48\">\n      <g id=\"Layer_2\" data-name=\"Layer 2\">\n        <g id=\"invisible_box\" data-name=\"invisible box\">\n          <rect width=\"48\" height=\"48\" fill=\"none\" />\n        </g>\n        <g id=\"Q3_icons\" data-name=\"Q3 icons\">\n          <g>\n            <path d=\"M24,10a2,2,0,0,0,2-2V4a2,2,0,0,0-4,0V8A2,2,0,0,0,24,10Z\" />\n            <path d=\"M24,38a2,2,0,0,0-2,2v4a2,2,0,0,0,4,0V40A2,2,0,0,0,24,38Z\" />\n            <path d=\"M36.7,14.1l2.9-2.8a2.3,2.3,0,0,0,0-2.9,2.3,2.3,0,0,0-2.9,0l-2.8,2.9a2,2,0,1,0,2.8,2.8Z\" />\n            <path d=\"M11.3,33.9,8.4,36.7a2.3,2.3,0,0,0,0,2.9,2.3,2.3,0,0,0,2.9,0l2.8-2.9a2,2,0,1,0-2.8-2.8Z\" />\n            <path d=\"M44,22H40a2,2,0,0,0,0,4h4a2,2,0,0,0,0-4Z\" />\n            <path d=\"M10,24a2,2,0,0,0-2-2H4a2,2,0,0,0,0,4H8A2,2,0,0,0,10,24Z\" />\n            <path d=\"M36.7,33.9a2,2,0,1,0-2.8,2.8l2.8,2.9a2.1,2.1,0,1,0,2.9-2.9Z\" />\n            <path d=\"M11.3,14.1a2,2,0,0,0,2.8-2.8L11.3,8.4a2.3,2.3,0,0,0-2.9,0,2.3,2.3,0,0,0,0,2.9Z\" />\n            <path d=\"M24,14A10,10,0,1,0,34,24,10,10,0,0,0,24,14Z\" />\n          </g>\n        </g>\n      </g>\n    </svg>\n  </button>\n</section>\n```\n\nAnd I use CSS to show or hide the appropriate SVG:\n\n```css\n// default to showing darkSun (ie, light mode)\n.lightSun {\n  display: none;\n}\n\n// show lightSun and hide darkSun in dark mode\n.dark .lightSun {\n  display: block;\n  fill: #fff;\n}\n.dark .darkSun {\n  display: none;\n}\n```\n\nNow I just add this code to all my pages, popping the JavaScript in my `footer.html` partial, and the SVG button to my `header.html` partial - now it's on every page!\n\n## This isn't perfect\n\nThis is by no means a perfect implementation - the biggest issue is that there's a \"flash of unstyled content\" when the page loads and it runs the JavaScript to detect if you have dark mode on, and _then_ applies the `dark` class to the `<body>` element. However, for this _incredibly basic site_ it happens in ~2ms, so I think it's a trade-off worth making for the utter simplicity of the implementation.\n\nYou can check out all the eventual code for this in this website's repository:\n - [darkmode.html partial](https://github.com/ripixel/ripixel-website/blob/master/partials/darkmode.html) (for the switching button, included on every page)\n - [footer.html partial](https://github.com/ripixel/ripixel-website/blob/master/partials/footer.html#L30) (for the switching JavaScript)\n - [styles_dark.css](https://github.com/ripixel/ripixel-website/blob/master/assets/styles/styles_dark.css) (the dark mode specific styles)\n\nGo click that sun in the top-right hand corner of the site and let me know what you think!\n",
    "link": "/thoughts/2023-01-04_Enabling-dark-mode.html"
  },
  {
    "section": "thoughts",
    "itemName": "2023-01-02_Deploying-to-Firebase-Preview-Channels-using-CircleCI-and-GitHub",
    "itemPath": "./items/thoughts/2023-01-02_Deploying-to-Firebase-Preview-Channels-using-CircleCI-and-GitHub.md",
    "outPath": "./public/thoughts/2023-01-02_Deploying-to-Firebase-Preview-Channels-using-CircleCI-and-GitHub.html",
    "relativePath": "thoughts/2023-01-02_Deploying-to-Firebase-Preview-Channels-using-CircleCI-and-GitHub.html",
    "type": "md",
    "date": "2023-01-02T00:00:00.000Z",
    "dateObj": "2023-01-02T00:00:00.000Z",
    "dateDisplay": "2 January 2023",
    "title": "Deploying To Firebase Preview Channels Using CircleCI And GitHub",
    "excerpt": "If you use Firebase to host your website, you may have seen the new Preview Channels functionality has entered Beta and wondered - what on earth is that?",
    "body": "If you use [Firebase](https://firebase.google.com/) to host your website, you may have seen the new [Preview Channels](https://firebase.google.com/docs/hosting/test-preview-deploy?authuser=0&hl=en#preview-channels) functionality has entered Beta and wondered - what on earth is that?\n\nI've recently been using [Renovate](https://github.com/renovatebot/renovate) to automatically handle dependency updates, and wanted a way to preview the automatically proposed changes without having to merge into staging and do that dance. Preview channels to the rescue!\n\nThis guide combines a few ideas:\n - Setting up preview channels\n - Grabbing the relevant URL for the just-deployed preview channel\n - Regex shenanigans\n - Posting a comment to a relevant GitHub PR\n\n## What is Firebase?\n\nLet's start at the beginning - Firebase is Google's free-to-use (up to a point) suite of Web application tools. Most notably (along with Firestore) is its hosting capability, which means given a set of files you can deploy a static application incredibly easily (note: there are also cloud functions and edge services to make it not static, but that's outside the realms of this post).\n\n## How do you get set up with Firebase?\n\nAs a quick start, you can't get better than the [Get started with Firebase Hosting](https://firebase.google.com/docs/hosting/quickstart?authuser=0&hl=en) page from Google which explains all the basics of getting set up with Firebase Hosting, that I won't repeat here as there's nothing I can add!\n\n## What is CircleCI?\n\n[CircleCI](https://circleci.com/) is deployment pipeline (aka CI/CD) platform, which is also free-to-use up to a point (with very generous allowances for Open Source projects), and is my pipeline of choice due to its usage in Enterprise spaces, which means using it in personal projects grants me experience with things I do for \"proper work\".\n\nIt also helps that it's fantastically configurable, fast, and y'know... free!\n\n## How do you get set up with CircleCI?\n\nCircleCI has a great [Getting started](https://circleci.com/docs/getting-started/) guide which should get you through the initial hoops of getting your repository building from GitHub, with some great initial templates for whatever your application needs.\n\nThis website uses it, so if you want to just see the output and you're confident with Continuous Deployment pipelines, go check out its [CircleCI config](https://github.com/ripixel/ripixel-website/blob/master/.circleci/config.yml).\n\n## What are Firebase Preview Channels?\n\nFirebase preview channels create a temporary version of your hosted application with some identifier available so you can \"preview\" any proposed changes. For example with this website, I build any PRs I raise on GitHub to a preview channel so I can check everything is working as expected and nothing has broken silently in the build process.\n\nSo, when I raise a PR CircleCI builds it, and asks Firebase to deploy it to a preview channel. I then post this URL back to GitHub so I can see it for real!\n\n![screenshot of github comment on a pull request](/deploying_to_firebase_gh_comment.png \"Look ma, a Github comment!\")\n\n## How to configure Firebase preview channels?\n\nSo now you've followed the [Get started with Firebase Hosting](https://firebase.google.com/docs/hosting/quickstart?authuser=0&hl=en) and [Getting started [with CircleCI]](https://circleci.com/docs/getting-started/) guides, and you've got a deployment pipeline for your application - well done! Now let's do something cool.\n\n### Configure your CI/CD\n\nYour CI/CD of choice should have a capability to ensure some steps only get run under certain conditions. For example on CircleCI for this very website, I have:\n\n```yaml\n# YAML\n\n# Jobs not listed for brevity\n\nworkflows:\n  build_and_deploy:\n    jobs:\n      - install_deps\n      - lint:\n          requires:\n            - install_deps\n      - build_dev:\n          filters:\n            branches:\n              ignore: master\n          requires:\n            - install_deps\n      - build_prod_with_version:\n          filters:\n            branches:\n              only: master\n          requires:\n            - install_deps\n      - deploy_to_firebase_prod:\n          filters:\n            branches:\n              only: master\n          requires:\n            - lint\n            - build_prod_with_version\n      - deploy_to_firebase_preview:\n          filters:\n            branches:\n              ignore:\n                - master\n                - staging\n          requires:\n            - lint\n            - build_dev\n      - deploy_to_firebase_stg:\n          filters:\n            branches:\n              only: staging\n          requires:\n            - lint\n            - build_dev\n```\n\nThis config means that if I push to these different branches, then these jobs run:\n  + push to `master`:\n    - `install_deps`\n    - `lint`\n    - `build_prod_with_version`\n    - `deploy_to_firebase_prod`\n  + push to `staging`:\n    - `install_deps`\n    - `lint`\n    - `build_dev`\n    - `deploy_to_firebase_stg`\n  + push to any other branch:\n    - `install_deps`\n    - `lint`\n    - `build_dev`\n    - `deploy_to_firebase_preview`\n\nAs an example of a non-preview deploy, the `deploy_to_firebase_prod` step is super simple:\n\n```yaml\n#YAML\n\njobs:\n  deploy_to_firebase_prod:\n    executor: node-project\n    steps:\n      - checkout\n      - restore_cache: # special step to restore the dependency cache\n          key: dependency-cache-{{ checksum \"package-lock.json\" }}\n      - restore_cache: # restore the /public folder and associated deploy files\n          key: deploy-cache-{{ .Environment.CIRCLE_WORKFLOW_ID }}\n      - run:\n          name: Deploy to Firebase Production Hosting\n          command: ./node_modules/.bin/firebase deploy --token \"$FIREBASE_TOKEN\" --only hosting:production\n```\n\nFirst off this step restores some caches from the `install_deps` and `build_prod_with_version` steps, before attempting to deploy to Firebase. You can see that I have to pass in `--token \"$FIREBASE_TOKEN\"` to authenticate (so I've added `FIREBASE_TOKEN` as an environment variable for the pipeline), as well as `--only hosting:production` to let Firebase know which platform I want to deploy to (as I have `production` and `staging` configured).\n\nI also prefer to use the project-installed version of firebase rather than do any `npm i -g firebase-tools` shenanigans, as it keeps the firebase version locked with the rest of the project, which prevents unexpected problems if firebase were to upgrade unexpectedly.\n\n### Deploying to Firebase Preview channel\n\nSo you're now deploying to Firebase for your \"normal\" deployments - production, staging, whatever. But let's get preview channels enabled! Let's see what a simple step might look like:\n\n```yaml\njobs:\n  deploy_to_firebase_preview:\n    executor: node-project\n    steps:\n      - checkout\n      - restore_cache: # special step to restore the dependency cache\n          key: dependency-cache-{{ checksum \"package-lock.json\" }}\n      - restore_cache: # restore the /public folder and associated deploy files\n          key: deploy-cache-{{ .Environment.CIRCLE_WORKFLOW_ID }}\n      - run:\n          name: Deploy to Firebase Preview Channel\n          command: ./node_modules/.bin/firebase hosting:channel:deploy $CIRCLE_BRANCH --token \"$FIREBASE_TOKEN\"\n```\n\nGreat, we've now got preview channels deploying - it really is that easy! As the \"unique ID\" we're using the `$CIRCLE_BRANCH` so that we don't create endless preview channels if the same branch gets updated. Note that you don't need the `--only hosting:x` parameter, as preview channels are _always_ only for hosting.\n\n### Posting a comment back to GitHub\n\nBut what if we want to post a GitHub comment on the PR that accompanies the branch? Then as an extra `run` step we could add:\n\n```yaml\n      - run:\n          name: Post Github PR Comment\n          command: |\n            sudo apt-get install jq\n\n            channels=$(./node_modules/.bin/firebase hosting:channel:list)\n            circle_branch_replaced=$(echo $CIRCLE_BRANCH | sed \"s/\\//-/\")\n            regex='(https:\\/\\/[a-z0-9-]*--'\"${circle_branch_replaced:0:39}\"'-[a-z0-9-]*.web.app)'\n            [[ $channels =~ $regex ]] && url=${BASH_REMATCH[0]}\n\n            if [ $(echo $url | jq length) -eq 0]; then\n              url=\"Unable to get URL - check Firebase console\"\n            fi\n\n            pr_response=$(curl --location --request GET \"https://api.github.com/repos/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/pulls?head=$CIRCLE_PROJECT_USERNAME:$CIRCLE_BRANCH&state=open\" \\\n            -u $GH_USER:$GH_TOKEN)\n\n            if [ $(echo $pr_response | jq length) -eq 0 ]; then\n              echo \"No PR found to update\"\n            else\n              pr_comment_url=$(echo $pr_response | jq -r \".[]._links.comments.href\")\n            fi\n\n            curl --location --request POST \"$pr_comment_url\" \\\n            -u $GH_USER:$GH_TOKEN \\\n            --header 'Content-Type: application/json' \\\n            --data-raw '{\"body\": \"Successfully deployed to Firebase preview channel! Available at: '\"$url\"'\"}'\n```\n\nThis step does a few things, and begins with some set up and variable assigning.\n\n`sudo apt-get install jq` installs the `jq` package to enable some functions we want to use in the script.\n\n`channels=$(./node_modules/.bin/firebase hosting:channel:list)` assigns a variable called `$channels` with a value of all the different preview channels that are currently live that Firebase is tracking. Assuming this command is run after a successful `firebase hosting:channel:deploy` run, this will include the most recently-deployed channel.\n\n`circle_branch_replaced=$(echo $CIRCLE_BRANCH | sed \"s/\\//-/\")` is replacing any forward slashes found in `$CIRCLE_BRANCH` with dashes, just like firebase will do if you pass in anything with slashes.\n\n`regex='(https:\\/\\/[a-z0-9-]*--'\"${circle_branch_replaced:0:39}\"'-[a-z0-9-]*.web.app)'` creates a regex that looks for the URL that looks like the channel you've just deployed. Firebase also only uses the first 40 characters of the ID (which is what `\"${circle_branch_replaced:0:39}\"` is doing). So our regex ends up something like:\n\n```\n(https:\\/\\/[a-z0-9-]*--mybranch-something-[a-z0-9-]*.web.app)\n```\n\nDon't forget the parenthesis around it so you create a regex capture group!\n\n`[[ $channels =~ $regex ]] && url=${BASH_REMATCH[0]}` uses the `$channels` and `$regex` variables we've defined above, and runs the regex against the channel list. It then assigns a variable called `$url` with the matched URL in a capture group.\n\nThe `if [ $(echo $url | jq length) -eq 0]; then` statement checks that we've actually found a URL by asserting the length of `$url` is greater than zero - if it's not, we assign an error message to the `$url` variable.\n\nNext up, we assign a curl target to the variable `$pr_response`. For this we need to create two environment variables for our pipeline: `GH_USER` and `GH_TOKEN`. `GH_USER` is your GitHub username, and `GH_TOKEN` is a [personal access token](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token) with read/write permissions for pull requests on the associated repository. We don't need to worry about any of those variables used prefixed with `$CIRCLE_` because they're all available to us for free!\n\nWe then check if we found a relevant PR using the `if [ $(echo $pr_response | jq length) -eq 0 ]; then` block, using `jq` to check the length as before. If we find one, we assign `$pr_comment_url` the URL we need to hit to add a comment.\n\nFinally, we perform the `curl` request to add the comment, using:\n\n```bash\ncurl --location --request POST \"$pr_comment_url\" \\\n  -u $GH_USER:$GH_TOKEN \\\n  --header 'Content-Type: application/json' \\\n  --data-raw '{\"body\": \"Successfully deployed to Firebase preview channel! Available at: '\"$url\"'\"}'\n```\n\nBe very careful when constructing your `--data-raw` - the way variable interpolations work in bash is confusing, so be sure to terminate your strings either side of it to not have any weirdness. You can see my doing this by doing:\n\n```bash\n# Bash will concatenate strings if side-by-side\nsome_var=hello\nresult='some \"text\" with double-quotes in it '\"$some_var\"' more text'\necho $result\n# some \"text\" with double-quotes in it hello more text\n```\n\n## Final Step Code\n\nEt voila! Putting it all together we have:\n\n```yaml\njobs:\n  deploy_to_firebase_preview: # deploy the project to preview channel - SHOULD ONLY BE RUN ON PR BRANCHES\n    executor: node-project\n    steps:\n      - checkout\n      - restore_cache: # special step to restore the dependency cache\n          key: dependency-cache-{{ checksum \"package-lock.json\" }}\n      - restore_cache: # restore the /public folder and associated deploy files\n          key: deploy-cache-{{ .Environment.CIRCLE_WORKFLOW_ID }}\n      - run:\n          name: Deploy to Firebase Preview Channel\n          command: ./node_modules/.bin/firebase hosting:channel:deploy $CIRCLE_BRANCH --token \"$FIREBASE_TOKEN\"\n      - run:\n          name: Post Github PR Comment\n          command: |\n            sudo apt-get install jq\n\n            channels=$(./node_modules/.bin/firebase hosting:channel:list)\n            circle_branch_replaced=$(echo $CIRCLE_BRANCH | sed \"s/\\//-/\")\n            regex='(https:\\/\\/[a-z0-9-]*--'\"${circle_branch_replaced:0:39}\"'-[a-z0-9-]*.web.app)'\n            [[ $channels =~ $regex ]] && url=${BASH_REMATCH[0]}\n\n            if [ $(echo $url | jq length) -eq 0]; then\n              url=\"Unable to get URL - check Firebase console\"\n            fi\n\n            pr_response=$(curl --location --request GET \"https://api.github.com/repos/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/pulls?head=$CIRCLE_PROJECT_USERNAME:$CIRCLE_BRANCH&state=open\" \\\n            -u $GH_USER:$GH_TOKEN)\n\n            if [ $(echo $pr_response | jq length) -eq 0 ]; then\n              echo \"No PR found to update\"\n            else\n              pr_comment_url=$(echo $pr_response | jq -r \".[]._links.comments.href\")\n            fi\n\n            curl --location --request POST \"$pr_comment_url\" \\\n            -u $GH_USER:$GH_TOKEN \\\n            --header 'Content-Type: application/json' \\\n            --data-raw '{\"body\": \"Successfully deployed to Firebase preview channel! Available at: '\"$url\"'\"}'\n```\n\nAnd now we have PRs (well, any branches that aren't `master` or `staging`) deploying to preview channels and posting back to the relevant PR with a comment to view the changes.\n\nTo see the entire build step for this website, check out its [CircleCI config](https://github.com/ripixel/ripixel-website/blob/master/.circleci/config.yml). It's not doing anything crazy - install dependencies, lint the repo, build the site, and deploy!\n",
    "link": "/thoughts/2023-01-02_Deploying-to-Firebase-Preview-Channels-using-CircleCI-and-GitHub.html"
  },
  {
    "section": "thoughts",
    "itemName": "2021-03-21_Webmentions-are-Fun",
    "itemPath": "./items/thoughts/2021-03-21_Webmentions-are-Fun.md",
    "outPath": "./public/thoughts/2021-03-21_Webmentions-are-Fun.html",
    "relativePath": "thoughts/2021-03-21_Webmentions-are-Fun.html",
    "type": "md",
    "date": "2021-03-21T00:00:00.000Z",
    "dateObj": "2021-03-21T00:00:00.000Z",
    "dateDisplay": "21 March 2021",
    "title": "Webmentions Are Fun",
    "excerpt": "Ever wondered if there's some way to let people know you think their web article/content is great, but also wanted it to be automated and snazzy?",
    "body": "Ever wondered if there's some way to let people know you think their web article/content is great, but also wanted it to be automated and snazzy?\n\nEnter [Webmentions](https://indieweb.org/Webmention), the cool little system to notify (and receive notifications about) people you liked/reposted/commented on their stuff! You can even hook it up to Twitter, and it's completely agnostic of whatever system you use to publish your little corner of the web.\n\n## So how do they work?\n\nSimply put, you have some service that accepts a request that you've been mentioned, and you yourself poke other services to let other people know that you've been mentioned.\n\nThat second bit sounds like it could be an absolute nightmare to figure out right? Wrong! The [Webmentions Spec](https://www.w3.org/TR/webmention/) has thought of this, and all you do is add some tags to your head to let people know whe to send mention requests (more on that in the [tutorial](#justshowmehowtodoitimhereforthecode) section).\n\nSo when you want to mention someone, you scrape the page you're mentioning, find the `webmention` link tag and fire your request there - easy!\n\nBut how about when you want to find out what you've been mentioned in? Well that depends on what service you use to accept your mention requests, but generally you'll just poke an API endpoint to retrieve them, et voila! You have all your webmentions, and you can do with them what you will (for example, I shove them at the end of an article).\n\n## Just show me how to do it, I'm here for the code!\n\nOk, so first things first, we've got to decide how to accept webmentions. For this entire guide, I'll be effectively using the process that [Luke Bonaccorsi](https://lukeb.co.uk/) noted in his excellent article [\"No comment: Adding Webmentions to my site\"](https://lukeb.co.uk/blog/2021/03/15/no-comment-adding-webmentions-to-my-site/#webmentions) (and because I've mentioned his article in mine, he'll get a webmention ping - neat!). He uses Eleventy and thus a slightly different integration path (he even made a build-plugin for it to make all this process super easy for everyone using Eleventy), but I've shamelessly copy/pasted his code here. Go give him a yell on Twitter [@CodeFoodPixels](https://twitter.com/CodeFoodPixels) telling him how great he is!\n\nOk, with that gushing out the way, we're going to use [webmention.io](https://webmention.io/) to receive mentions for us, and [webmention.app](https://webmention.app/) to send mentions to other people.\n\n### Accepting webmentions\n\nTo get started accepting webmentions with .io, we've got to let it know we are responsible for that site. So you need to do two things.\n\nFirstly, ensure that your website is on the profile of one of the sign on mechanisms they support, so for me that was Twitter or GitHub. Then you need to add `rel=\"me\"` to a link to that profile on your website, for example:\n\n```html\n<!-- HTML -->\n\n<a href=\"https://github.com/your_gh_username\" rel=\"me\">GitHub</a>\n<a href=\"https://www.twitter.com/your_twitter_handle\" rel=\"me\">Twitter</a>\n```\n\nNow when you enter your website into the sign in page of .io, it'll ask you to sign in using one of those platforms - noice.\n\nNow you need to add some tags to your `<head>` so .io knows you want to use it:\n\n```html\n<!-- HTML -->\n\n<link\n  rel=\"webmention\"\n  href=\"https://webmention.io/www.your-website.com/webmention\"\n/>\n<link rel=\"pingback\" href=\"https://webmention.io/www.your-website.com/xmlrpc\" />\n```\n\nOnce you've done that, that's it! You're ready to accept webmentions! Any pages trying to send a webmention will see those tags, and know where to send requests.\n\n### Rendering webmentions\n\nSo this will be different depending on how your website works, but as I'm a crazy person who wrote their own (admittedly very noddy) Static Site Generator, I had to do all this manually (code shamelessly stolen from Luke's article).\n\nSo, when I'm generating my articles, I first get all the webmentions for my site using the below script:\n\n```typescript\n// TypeScript\n\nexport const getWebmentions = async (): Promise<any[]> => {\n  const url = `${WEBMENTION_BASE_URL}?domain=${DOMAIN}&token=${WEBMENTION_IO_TOKEN}&per-page=1000`;\n\n  try {\n    const res = await fetch(url);\n    if (res.ok) {\n      const feed = await res.json();\n      return feed.children as any[];\n    }\n  } catch (err) {\n    console.error(err);\n    return [];\n  }\n  return [];\n};\n```\n\nEnsure you define `WEBMENTION_BASE_URL`, `DOMAIN` and your `WEBMENTION_IO_TOKEN`, and you when this runs you'll now have all webmentions for your entire website!\n\nSo the next step is to filter out the webmentions you care about for each page. The following script takes all the webmentions, and filters out the ones that aren't any of the types we care about (more on that in a moment), and only for the page we care about:\n\n```typescript\n// TypeScript\n\nexport const webmentionsForPage = (\n  webmentions: any[],\n  page: string\n): {\n  likes: any[];\n  reposts: any[];\n  comments: any[];\n} => {\n  const url = new URL(\n    page.replace('.html', ''),\n    `https://${DOMAIN}/`\n  ).toString();\n\n  const allowedTypes = {\n    likes: ['like-of'],\n    reposts: ['repost-of'],\n    comments: ['mention-of', 'in-reply-to'],\n  };\n\n  const clean = (entry: any) => {\n    if (entry.content) {\n      if (entry.content.text.length > 280) {\n        entry.content.value = `${entry.content.text.substr(0, 280)}&hellip;`;\n      } else {\n        entry.content.value = entry.content.text;\n      }\n    }\n    return entry;\n  };\n\n  const cleanedWebmentions = webmentions\n    .filter((mention) => mention['wm-target'] === url)\n    .sort(\n      (a, b) =>\n        new Date(b.published).getTime() - new Date(a.published).getTime()\n    )\n    .map(clean);\n\n  const likes = cleanedWebmentions\n    .filter((mention) => allowedTypes.likes.includes(mention['wm-property']))\n    .filter((like) => like.author)\n    .map((like) => like.author);\n\n  const reposts = cleanedWebmentions\n    .filter((mention) => allowedTypes.reposts.includes(mention['wm-property']))\n    .filter((repost) => repost.author)\n    .map((repost) => repost.author);\n\n  const comments = cleanedWebmentions\n    .filter((mention) => allowedTypes.comments.includes(mention['wm-property']))\n    .filter((comment) => {\n      const { author, published, content } = comment;\n      return author && author.name && published && content;\n    });\n\n  return {\n    likes: likes ?? [],\n    reposts: reposts ?? [],\n    comments: comments ?? [],\n  };\n};\n```\n\nYou'll note that we're only caring about the `like-of`, `repost-of`, `mention-of`, and `in-reply-to` types (with those last two types lumped together as `comments`).\n\nSo for each article page I'm generating, I pass in all the webmentions and the page path, and get back an object with the `likes`, `reposts`, and `comments` keys.\n\nNow this is where my janky SSG really makes things look complicated, but essentially my HTML files have some handlebars-esque markers where content should go and be repeated - so I take that, and replace the values with each type of mention. For example:\n\n```html\n<!-- HTML -->\n\n<!-- START_MENTIONS -->\n<main class=\"thoughts mentions\">\n  <!-- START_LIKES -->\n  <div class=\"likes\">\n    <h4>{LIKES} likes</h4>\n    <div class=\"mention-links\">\n      <!-- START_LIKES_REP -->\n      <a\n        class=\"item\"\n        href=\"{mention_link}\"\n        target=\"_blank\"\n        rel=\"external noopener noreferrer\"\n      >\n        <img\n          src=\"{mention_avatar}\"\n          loading=\"lazy\"\n          decoding=\"async\"\n          width=\"28\"\n          height=\"28\"\n        /><span>{mention_name}</span></a\n      >\n      <!-- END_LIKES_REP -->\n    </div>\n  </div>\n  <!-- END_LIKES -->\n\n  <!-- START_REPOSTS -->\n  <div class=\"reposts\">\n    <h4>{REPOSTS} reposts</h4>\n    <div class=\"mention-links\">\n      <!-- START_REPOSTS_REP -->\n      <a\n        class=\"item\"\n        href=\"{mention_link}\"\n        target=\"_blank\"\n        rel=\"external noopener noreferrer\"\n      >\n        <img\n          src=\"{mention_avatar}\"\n          loading=\"lazy\"\n          decoding=\"async\"\n          width=\"28\"\n          height=\"28\"\n        /><span>{mention_name}</span></a\n      >\n      <!-- END_REPOSTS_REP -->\n    </div>\n  </div>\n  <!-- END_REPOSTS -->\n\n  <!-- START_COMMENTS -->\n  <div class=\"comments\">\n    <h4>{COMMENTS} comments</h4>\n    <div class=\"mention-links\">\n      <!-- START_COMMENTS_REP -->\n      <div class=\"comment\">\n        <a\n          class=\"item\"\n          href=\"{mention_link}\"\n          target=\"_blank\"\n          rel=\"external noopener noreferrer\"\n        >\n          <img\n            src=\"{mention_avatar}\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            width=\"28\"\n            height=\"28\"\n          /><span>{mention_name}</span></a\n        >\n        <p>{comment}</p>\n        <a\n          class=\"item comment-link\"\n          href=\"{comment_link}\"\n          target=\"_blank\"\n          rel=\"external noopener noreferrer\"\n          ><span>View</span></a\n        >\n      </div>\n      <!-- END_COMMENTS_REP -->\n    </div>\n  </div>\n  <!-- END_COMMENTS -->\n</main>\n<!-- END_MENTIONS -->\n```\n\nThose `<!-- START_X -->` and `<!-- END_X -->` blocks are for my SSG script to see which bits should be repeated. The script that then replaces them looks something like (omitting the SSG janky bits):\n\n```typescript\n// TypeScript\n\nconst generateWebmentionBlock = (\n  tag: 'COMMENTS' | 'LIKES' | 'REPOSTS',\n  content: string,\n  mentions: any[]\n): string => {\n  const isComment = tag === 'COMMENTS';\n\n  // I'm omitting the whole bit around grabbing the repeating blocks from the content,\n  // but that happens here if I were to subject you to my horrible hacky \"Oh that'll\n  // do\" coding for personal stuff. You can always see the source code for this site\n  // on my GitHub if you really want to see how bad it is...!\n\n  return mentions\n    .map((mention) => {\n      return content\n        .replace(\n          /{mention_link}/g,\n          !isComment ? mention.url : mention.author.url\n        )\n        .replace(\n          /{mention_avatar}/g,\n          (!isComment ? mention.photo : mention.author.photo) ??\n            '/default_avatar.png'\n        )\n        .replace(\n          /{mention_name}/g,\n          !isComment ? mention.name : mention.author.name\n        )\n        .replace(/{comment}/g, isComment ? mention.content.value : '')\n        .replace(/{comment_link}/g, isComment ? mention.url : '');\n    })\n    .join('');\n};\n```\n\nAnd that's it! Do that for every page, and every type of mention, and you've now got webmentions into your site!\n\n### Wait, that just does it at build time - won't webmentions come in over time?\n\nWhy yes voice in my head, you're correct! This will only grab the state of webmentions whenever the build runs.\n\nTo remedy this, I've set my build job on CircleCi to run every hour to grab new mentions and the site it generates and deploys will then have any new mentions. There are ways to configure webmention.io to poke a URL when you receive a mention, but I didn't want that to trigger masses of builds if I were to go #viral - so every hour it is!\n\n```yaml\n# Yaml\n\nworkflows:\n  version: 2\n  hourly:\n    triggers:\n      - schedule:\n          cron: '55 * * * *' # 5 mins to every hour it will run\n          filters:\n            branches:\n              only:\n                - master\n```\n\n### Sending webmentions\n\nOk so we're now accepting webmentions ourselves, and rendering those on our pages. But how do we partake in the community happiness and send webmentions ourselves? Well now we get to play with webmention.app, and you'll see it's as simple as doing a `POST` request to `https://webmention.app/check/?url=:url` whenever we publish a new article.\n\nYou can also hook it up to various things, all walked through on the excellent homepage (RSS feeds are particularly useful!) which I won't repeat here for the sake of your sanity.\n\n### Ok, but what about Twitter integration?\n\nThat's actually the simplest bit! Using [Bridgy](https://brid.gy/) you can connect your Twitter account, and it will monitor your profile for any likes/retweets/replies for links that are webmention-able, and automatically do all the scraping and sending for you!\n\n## Hey presto!\n\nI love it when the web decides \"hey, wouldn't it be cool if...?\" and a bunch of smart people get together and make it happen. Even better when some of those smart people create free apps like webmention.io, webmention.app, and brid.gy to make it super simple for everyone else to get started!\n\nBig thanks to Luke's [excellent article](https://lukeb.co.uk/blog/2021/03/15/no-comment-adding-webmentions-to-my-site/#webmentions) for being so easy to follow; I'm simply typing it up again for the sake of writing an article myself, and spreading the webmention love.\n\nGo make awesome things, and who knows, maybe this article will even get some interactions!\n",
    "link": "/thoughts/2021-03-21_Webmentions-are-Fun.html"
  },
  {
    "section": "thoughts",
    "itemName": "2020-08-16_Stop-Blaming-Slack",
    "itemPath": "./items/thoughts/2020-08-16_Stop-Blaming-Slack.md",
    "outPath": "./public/thoughts/2020-08-16_Stop-Blaming-Slack.html",
    "relativePath": "thoughts/2020-08-16_Stop-Blaming-Slack.html",
    "type": "md",
    "date": "2020-08-16T00:00:00.000Z",
    "dateObj": "2020-08-16T00:00:00.000Z",
    "dateDisplay": "16 August 2020",
    "title": "Stop Blaming Slack",
    "excerpt": "These unprecedented times have caused many companies to shift to or expand their usage of communication technologies, such as Microsoft Teams and Slack. With this expansion have come teething issues - as would be expected.",
    "body": "These unprecedented times have caused many companies to shift to or expand their usage of communication technologies, such as Microsoft Teams and Slack. With this expansion have come teething issues - as would be expected.\r\n\r\nWhat I didn't expect though is the number of articles decrying Slack specifically as mostly a terrible thing, and that it [\"has made work more taxing\"](https://www.ft.com/content/e036016c-39f0-4ce7-a64b-845f764d3254). To those writing these articles: stop blaming Slack.\r\n\r\n## Slack is not a real-time communication app\r\n\r\nSlack (and other workplace communication tools) are primarily intended to replace (or supplement) _email_. You know, that incredibly slow, old-fashioned, and unreliable mechanism. The one where you have to trawl through endless replies/forwards/\"I don't think they're CC'd into this email chain\" messages to find the actual information you want. Or even more accurately, to often find that most of the emails you receive you don't even need to read.\r\n\r\nSlack steps in here, allowing companies who use it to create channels, stick all the people related to that topic (ie #team-marketing), so that anything the marketing team needs gets posted there.\r\n\r\nJust because you've posted it however, doesn't mean that someone will respond immediately. Slack is an **asynchronous communication tool**, just like email. It just-so-happens that because it's so much easier to use, that people tend to respond more quickly. With that said though...\r\n\r\n## Do not expect instant replies\r\n\r\nThe main complaint is that \"there's a lot of interruptions\", because Slack users are sending and receiving between 800 and 2,500 messages a month.\r\n\r\nAs I've noted above, just because a message has been sent does not guarantee immediate response - nor should you expect that as a user or company. Users can be busy in a meeting, or concentrating on getting some work done. Slack has an excellent \"Do Not Disturb\" function which when turned on, will inform other people trying to message you directly that you have notifications paused, and give you (the sender) the opportunity to override this if it's urgent.\r\n\r\nIt's important that you respect the Do Not Disturb flag, and that your employees can feel free to turn it on without fear of being hounded by unnecessary messages. I'm sure if you could wait 2 days for a reply by email, you can wait a few hours for a reply by Slack.\r\n\r\n## Stop having loads of communication tools\r\n\r\nYet another issue is that \"now I have to monitor email and Slack\" - again, not Slack's fault - it's your company.\r\n\r\nWhile it's true Slack is not a complete replacement for email (you still need to email people outside of your organisation, unless you have brought them into your Slack org via a shared channel), Slack _should_ replace **all internal email**. I should only be checking it for external communications, which I should receive a lot fewer of in the first place. If people are still sending things via email that should be via Slack, employees should feel able to say \"Hey, for future communications can you pop into our Slack channel?\" without fear of reprimand.\r\n\r\nIf you find yourself having to check multiple communication apps, then please, for the love of all that is holy, as an organization **pick one and ditch the others**. Be that Slack, Teams, Facebook Workplace, or whatever. You may say \"Oh but the marketing team prefer X and the business ops team prefer Y\", but at the end of the day it's much-of-a-muchness. You will reduce hate, workload, and stress by having a single internal communications platform.\r\n\r\n## Why should I bother?\r\n\r\nAnecdotally, at a previous company I was receiving ~200 emails a day - maybe 30 of which needed addressing by me. Another 50 or so were \"FYI\"-type CCs. The rest were garbage. Now, I'm in the Slack channels I need to be in, and I can immediately see which channels have new messages and if I've been directly mentioned, all without actually opening said messages. I can choose to address these at my own pace (if I see #super-critical-project blinking like a Christmas tree, I may answer immediately for example), and via good company practice and usage of the Do Not Disturb function, get some decent blocks of time to concentrate on tasks.\r\n\r\nEmail is slow, clunky, insecure, and out-dated. Yes it has its use as being a universal electronic communication form, but for the same reason I don't fax people anymore, you shouldn't be sending emails when much better alternatives are available.\r\n\r\nPick a single communication tool, champion its use, and don't expect more of your employees just because you've got a shiny new app. Stop blaming Slack; it's your processes at fault.\r\n",
    "link": "/thoughts/2020-08-16_Stop-Blaming-Slack.html"
  },
  {
    "section": "thoughts",
    "itemName": "2020-07-04_Talk-To-Your-Engineers",
    "itemPath": "./items/thoughts/2020-07-04_Talk-To-Your-Engineers.md",
    "outPath": "./public/thoughts/2020-07-04_Talk-To-Your-Engineers.html",
    "relativePath": "thoughts/2020-07-04_Talk-To-Your-Engineers.html",
    "type": "md",
    "date": "2020-07-04T00:00:00.000Z",
    "dateObj": "2020-07-04T00:00:00.000Z",
    "dateDisplay": "4 July 2020",
    "title": "Talk To Your Engineers",
    "excerpt": "We've all been there - the sales person says \"Hey everyone, I've just got us a new project!\". At this point all the engineers look at each other, and realise that none of them have been spoken to regarding the project.",
    "body": "We've all been there - the sales person says \"Hey everyone, I've just got us a new project!\". At this point all the engineers look at each other, and realise that none of them have been spoken to regarding the project.\n\nAs one, they exclaim the hallowed word, echoed throughout time - \"Fuck.\".\n\nThey know what's about to happen - they're about to be asked to deliver a project that has been scoped out by the sales team, and will inevitably have bizarre requirements, unachievable deadlines, or both! \"Why oh why did no one ask us about this? We would've helped!\".\n\n## \"That's not their job! It's the Sales Team's job!\"\n\nSales teams are incredible. Their ability to take client problems and figure out how their specific company's tech can help them solve it is nothing short of miraculous. The documents and proposal they create are worthy of literacy awards, and the RoI promised is nothing short of Bill-Gates-money amazing.\n\nThe problem is that unless they've spoken to someone in the engineering team, any dates or cost for that integration are **almost certainly wrong**, along with assumptions about what the underlying technologies may be, and how they fit together.\n\n## \"We don't have any sales engineers though!\"\n\nJust because you don't have any specific sales engineers (or whatever you want to call them), this doesn't mean your current engineers cannot help with the sales process. If you don't feel that they'd be good in front of clients, then fine - just take down the client requirements in as much detail as you can, and then take that to them. We engineers love figuring out how we can solve a problem, and we'll be delighted you included us in the process. You can then take your discoveries back to the client, and have a more informed conversation about what you can offer.\n\nIf you are lucky enough to have dedicated sales engineers, then amazing; get them involved as soon as you can! Put them in front of a client, and let that conversation begin.\n\nEven if you're in the _incredibly_ rare boat of having fully-fledged engineers within your sales team, then I still urge you to get the delivery team engineers involved. Their being on the frontline of developing solutions will _always_ give them more context than those who are not.\n\nThe point is, engineers provide valuable insight into accurately estimating and understanding a project. There will be nuances no one has thought of, intricacies that escape both parties, and similarities (including problems faced) to previous solutions that are only obvious to them.\n\n## \"Engineers are there to build the solution, not sell or recommend one!\"\n\nIf this is your mindset, that needs to change _right now_. If your engineers are simply code-monkeys who do what they're told, you're losing out on **so much value**. Give them the chance to input into the solution, and I guarantee the end result will be better for it.\n\n## \"What do you know? You're just some random guy!\"\n\nI'm [lucky enough to work somewhere](https://dvelp.co.uk) that takes its engineers seriously, and our engineering-first mindset is a core tenant of our value to clients. We get engineers involved as early as possible, start talking shop, and make wonderful things happen. As a happy coincidence, clients love seeing that we get engineers involved early and often - it shows dedication and commitment that we're taking their problem seriously.\n\nSo yeah - trust your engineers, and get them involved. You'll love what happens.\n",
    "link": "/thoughts/2020-07-04_Talk-To-Your-Engineers.html"
  },
  {
    "section": "thoughts",
    "itemName": "2019-09-09_The-Importance-of-Monitoring-and-Alerting",
    "itemPath": "./items/thoughts/2019-09-09_The-Importance-of-Monitoring-and-Alerting.md",
    "outPath": "./public/thoughts/2019-09-09_The-Importance-of-Monitoring-and-Alerting.html",
    "relativePath": "thoughts/2019-09-09_The-Importance-of-Monitoring-and-Alerting.html",
    "type": "md",
    "date": "2019-09-09T00:00:00.000Z",
    "dateObj": "2019-09-09T00:00:00.000Z",
    "dateDisplay": "9 September 2019",
    "title": "The Importance Of Monitoring And Alerting",
    "excerpt": "We all know that monitoring and alerting are important, right? But just _how_ important do we really think that? How much do we show that in what we do?",
    "body": "We all know that monitoring and alerting are important, right? But just _how_ important do we really think that? How much do we show that in what we do?\n\nThis is a story about an experience I had at a previous company, where I had the pleasure of being at least partially responsible for the system going down, and what we learned.\n\n## What happened?\n\nAs some scene-setting - we had to implement a service that would be accessed anytime a user visited the site. I did the work, got it reviewed, tested, and hey-presto, got it live. More testing, ensure nothing went bang, and went home.\n\nThe next morning, I return to work, and all is well. About 3 hours in the site goes down. _Panic!_ Time to follow the steps...\n\n1. Who deployed last? - _Not me!_\n2. What big changes have we made recently? - _I did something yesterday, but everything's been fine for 24 hours, it can't be me!_\n3. Check the logs - _\"Cannot access the service that you implemented\"_\n4. _Gulp._\n\n## How did we fix it?\n\nFor the purpose of this story, this is actually not important (although obviously the initial fix was we just rolled back to pre-my-change). What is important is _how did we get here_.\n\n## So, how did we get here?\n\nOh, so many questions, so few graphs...\n\n### The Service\n\nFirst thing's first - let's have a look at the monitoring that was in place on the service I was calling:\n\n![alt text](https://dvelp-production.s3.amazonaws.com/uploads/image/file/176/x_large_1568038815-tol_service_initial.PNG \"Service - Initial\")\n\nEverything looks fine! Let's check the whole view:\n\n![alt text](https://dvelp-production.s3.amazonaws.com/uploads/image/file/177/x_large_1568038850-tol_service_final.PNG \"Service - Final\")\n\nOh dear. So, the service was getting warmer and warmer, until it reached 100% usage and any subsequent requests stopped being served, failed, and the site calling it fell over.\n\n### The Site\n\nOk, so the service got overloaded. Let's have a look at the number of calls we were making... _oh. There is no monitoring on the number of calls we were making._\n\nOk, let's assume we did have that monitoring in place - what is the expected number of calls?\n\n![alt text](https://dvelp-production.s3.amazonaws.com/uploads/image/file/178/x_large_1568038873-tol_site_expected.PNG \"Site Expected\")\n\nGreat - now let's have a look at the actual:\n\n![alt text](https://dvelp-production.s3.amazonaws.com/uploads/image/file/179/x_large_1568038897-tol_site_actual.PNG \"Site Actual\")\n\nI think that would do it, yes. Overloading the service with around 50x the expected calls (that's already taking into account the headroom planned).\n\n## Time to assign blame\n\nThere's a common misunderstanding with coding, in that the coder themself is to blame when things go wrong. That's not _incorrect_, but it's certainly not the whole story. Let's have a look at who else was involved in that deployment:\n\n- The developer who created the change\n- The developers who reviewed and approved the change\n- The testers who missed the issue\n- The engineering manager who approved the approach\n- The team responsible for the service being called\n\nSo it's not so simple. Software development is a team effort, so there's never a single person to blame.\n\n## What did we learn?\n\nTo quote the product owner:\n\n> Why the hell didn't we know about this earlier, before it became an issue?\n\nIt's the only question that really matters in this instance. We had monitoring for the service, but no alerting set up for when it was getting too warm. We had no monitoring in place at all for the number of calls being made, and therefore no alerting.\n\nSo, some takeaways from my (traumatic) trip down memory lane about how I took down a site:\n\n- Data is only important if you use it\n- Graphs and alerts are really boring until _they save you_\n- Give developers time to make \"of no immediate value\" things like monitoring and alerting, and make it part of any Acceptance into Service checklists\n\n_This thought was first published on the [DVELP blog](https://dvelp.co.uk/articles/monitoring-and-alerting) - but it was still written by me!_\n",
    "link": "/thoughts/2019-09-09_The-Importance-of-Monitoring-and-Alerting.html"
  }
]